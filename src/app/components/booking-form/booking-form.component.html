<form class="booking-form" [formGroup]="form" (ngSubmit)="onSubmit()">
  <!-- Conflict Warning (Full Width) -->
  <div *ngIf="bookingConflict$ | async as conflict" class="booking-form__conflict-warning">
    <mat-icon>warning</mat-icon>
    <span>
      Dieser Zeitraum ist bereits gebucht von {{ conflict.name }} ({{ formatTime(conflict.start_time) }} - {{ formatTime(conflict.end_time) }} Uhr).
      <ng-container *ngIf="availabilityCountdown$ | async as countdown">
        {{ countdown }}
      </ng-container>
    </span>
  </div>

  <!-- Booking Timeline (Full Width) - Visual timeline showing current and upcoming bookings -->
  <div *ngIf="liveStatus().type === 'currently-booked' && liveStatus().timelineSegments" class="booking-timeline">
    <!-- Header -->
    <div class="booking-timeline__header">
      <mat-icon class="booking-timeline__icon">schedule</mat-icon>
      <div class="booking-timeline__title">
        Raum aktuell belegt bis {{ liveStatus().blockEndTime | date:'HH:mm' }} Uhr
      </div>
    </div>

    <!-- Segmented Timeline Bar -->
    <div class="booking-timeline__bar">
      <div
        *ngFor="let segment of liveStatus().timelineSegments; let i = index"
        class="booking-timeline__segment"
        [class.booking-timeline__segment--active]="i === liveStatus().currentSegmentIndex"
        [style.flex-grow]="segment.widthPercent">

        <!-- Segment Label -->
        <span class="booking-timeline__segment-label">{{ segment.booker }}</span>

        <!-- Progress Fill (only for active segment) -->
        <div
          *ngIf="i === liveStatus().currentSegmentIndex"
          class="booking-timeline__progress"
          [style.width.%]="liveStatus().currentSegmentProgress">
        </div>
      </div>
    </div>

    <!-- Countdown for Current Meeting -->
    <div class="booking-timeline__countdown" *ngIf="shouldShowCountdown()">
      <mat-icon class="countdown-icon">timer</mat-icon>
      <span class="countdown-text">
        {{ getCurrentSegmentBooker() }}'s Meeting endet in: {{ countdownText() }}
      </span>
    </div>

    <!-- Next Booking Info -->
    <div class="booking-timeline__next" *ngIf="liveStatus().nextBooker">
      <mat-icon class="next-icon">arrow_forward</mat-icon>
      <span>Nächste Buchung: {{ liveStatus().nextBooker }} um {{ liveStatus().nextBookingStartTime | date:'HH:mm' }} Uhr</span>
    </div>
  </div>

  <!-- Two-Column Layout -->
  <div class="booking-form__columns">

    <!-- LEFT COLUMN: Was & Wann? -->
    <section class="booking-form__column booking-form__column--left">
      <h3 class="booking-form__section-title">
        <mat-icon>event</mat-icon>
        Was & Wann?
      </h3>

      <mat-form-field appearance="outline">
        <mat-label>Raum</mat-label>
        <mat-select formControlName="roomId" required>
          <mat-option *ngFor="let room of rooms" [value]="room.id">
            {{ room.name }} · {{ room.capacity }} Personen
          </mat-option>
        </mat-select>
        <mat-error>Bitte wählen Sie einen Raum.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Datum</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="date" required />
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
        <mat-error>Bitte wählen Sie ein Datum.</mat-error>
      </mat-form-field>

      <div class="booking-form__time-fields">
        <mat-form-field appearance="outline">
          <mat-label>Beginn</mat-label>
          <input matInput type="time" formControlName="startTime" required />
          <mat-hint>Automatisch vorausgewählt</mat-hint>
          <mat-error>Bitte wählen Sie eine Startzeit.</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Ende</mat-label>
          <input matInput type="time" formControlName="endTime" required />
          <mat-hint>Automatisch vorgeschlagen</mat-hint>
          <mat-error *ngIf="form.get('endTime')?.hasError('required')">
            Bitte wählen Sie eine Endzeit.
          </mat-error>
          <mat-error *ngIf="form.hasError('invalidTimeRange')">
            Die Endzeit muss nach der Startzeit liegen.
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Loading indicator -->
      <div class="booking-form__loading" *ngIf="isLoadingSlots()">
        <mat-spinner diameter="24"></mat-spinner>
        <span>Suche nach verfügbaren Slots...</span>
      </div>

      <!-- Suggestion Chips: Proactive time slot suggestions -->
      <div class="booking-form__suggestions" *ngIf="!isLoadingSlots() && suggestedSlots().length > 0">
        <span class="booking-form__suggestions-label">Verfügbare Slots:</span>
        <mat-chip-set aria-label="Available time slots">
          <mat-chip-option
            *ngFor="let slot of suggestedSlots(); let i = index"
            [selected]="selectedSlotIndex() === i"
            (click)="selectSlot(i)"
            [class.booking-form__chip--selected]="selectedSlotIndex() === i">
            {{ slot.startTime }} Uhr
          </mat-chip-option>
        </mat-chip-set>
      </div>

      <!-- Empty state message when no slots available -->
      <div class="booking-form__no-slots" *ngIf="!isLoadingSlots() && form.get('roomId')?.value && form.get('date')?.value && suggestedSlots().length === 0">
        <mat-icon>event_busy</mat-icon>
        <span>Keine freien Slots für diesen Tag verfügbar.</span>
      </div>
    </section>

    <!-- RIGHT COLUMN: Wer & Warum? -->
    <section class="booking-form__column booking-form__column--right">
      <h3 class="booking-form__section-title">
        <mat-icon>person</mat-icon>
        Wer & Warum?
      </h3>

      <mat-form-field appearance="outline">
        <mat-label>Ihr Name</mat-label>
        <input matInput formControlName="name" required #nameInput />
        <mat-error>Bitte geben Sie Ihren Namen ein.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="booking-form__comment-field">
        <mat-label>Kommentar (optional)</mat-label>
        <textarea matInput rows="6" formControlName="comment"
                  placeholder="z.B. Team-Meeting, Workshop, etc."></textarea>
        <mat-hint>Optional: Zweck der Buchung</mat-hint>
      </mat-form-field>
    </section>
  </div>

  <!-- Actions (Bottom Right) -->
  <div class="booking-form__actions">
    <button mat-stroked-button type="button" (click)="onReset()" [disabled]="isSubmitting">
      <mat-icon>refresh</mat-icon>
      Zurücksetzen
    </button>
    <button mat-flat-button color="primary" type="submit" [disabled]="isSubmitDisabled()">
      <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
      <mat-icon *ngIf="!isSubmitting">event_available</mat-icon>
      {{ isSubmitting ? 'Wird gespeichert...' : 'Buchung speichern' }}
    </button>
  </div>
</form>
