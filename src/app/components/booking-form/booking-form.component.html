<form class="booking-form" [formGroup]="form" (ngSubmit)="onSubmit()">
  <!-- Conflict Warning (Full Width) -->
  <!-- SMART UI: Suppressed when "Live Status" timeline is visible (higher priority) -->
  @if (bookingConflict(); as conflict) {
    @if (liveStatus().type !== 'currently-booked') {
      <div class="booking-form__conflict-warning">
        <mat-icon>warning</mat-icon>
        <span>
          Dieser Zeitraum ist bereits gebucht von {{ conflict.name }} ({{ formatTime(conflict.start_time) }} - {{ formatTime(conflict.end_time) }} Uhr).
          @if (availabilityCountdown(); as countdown) {
            {{ countdown }}
          }
        </span>
      </div>
    }
  }

  <!-- Booking Timeline (Full Width) - Visual timeline showing current and upcoming bookings -->
  @if (liveStatus().type === 'currently-booked' && liveStatus().timelineSegments) {
    <div class="booking-timeline">
      <!-- Header -->
      <div class="booking-timeline__header">
        <mat-icon class="booking-timeline__icon">schedule</mat-icon>
        <div class="booking-timeline__title">
          Raum aktuell belegt bis {{ liveStatus().blockEndTime | date:'HH:mm' }} Uhr
        </div>
      </div>

      <!-- Segmented Timeline Bar -->
      <div class="booking-timeline__bar">
        @for (segment of liveStatus().timelineSegments; track segment.booker + segment.startTime; let i = $index) {
          <div
            class="booking-timeline__segment"
            [class.booking-timeline__segment--active]="i === liveStatus().currentSegmentIndex"
            [style.flex-grow]="segment.widthPercent">

            <!-- Segment Label -->
            <span class="booking-timeline__segment-label">{{ segment.booker }}</span>

            <!-- Progress Fill (only for active segment) -->
            @if (i === liveStatus().currentSegmentIndex) {
              <div
                class="booking-timeline__progress"
                [style.width.%]="liveStatus().currentSegmentProgress">
              </div>
            }
          </div>
        }
      </div>

      <!-- Countdown for Current Meeting -->
      @if (shouldShowCountdown()) {
        <div class="booking-timeline__countdown">
          <mat-icon class="countdown-icon">timer</mat-icon>
          <span class="countdown-text">
            {{ getCurrentSegmentBooker() }}'s Meeting endet in: {{ countdownText() }}
          </span>
        </div>
      }

      <!-- Next Booking Info -->
      @if (liveStatus().nextBooker) {
        <div class="booking-timeline__next">
          <mat-icon class="next-icon">arrow_forward</mat-icon>
          <span>Nächste Buchung: {{ liveStatus().nextBooker }} um {{ liveStatus().nextBookingStartTime | date:'HH:mm' }} Uhr</span>
        </div>
      }
    </div>
  }

  <!-- Two-Column Layout -->
  <div class="booking-form__columns">

    <!-- LEFT COLUMN: Was & Wann? -->
    <section class="booking-form__column booking-form__column--left">
      <h3 class="booking-form__section-title">
        <mat-icon>event</mat-icon>
        Was & Wann?
      </h3>

      <mat-form-field appearance="outline" [class.smart-rebooking-active]="isSmartRebooking()">
        <mat-label>Raum</mat-label>
        <mat-select formControlName="roomId" required>
          @for (room of rooms(); track room.id) {
            <mat-option [value]="room.id">
              {{ room.name }} · {{ room.capacity }} Personen
            </mat-option>
          }
        </mat-select>
        <mat-error>Bitte wählen Sie einen Raum.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Datum</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="date" required />
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
        <mat-error>Bitte wählen Sie ein Datum.</mat-error>
      </mat-form-field>

      <div class="booking-form__time-fields">
        <mat-form-field appearance="outline" [class.smart-rebooking-active]="isSmartRebooking()">
          <mat-label>Beginn</mat-label>
          <input
            matInput
            formControlName="startTime"
            [ngxTimepicker]="startTimePicker"
            [format]="24"
            readonly
            required />
          <mat-icon matSuffix (click)="startTimePicker.open()">access_time</mat-icon>
          <ngx-material-timepicker
            #startTimePicker
            [confirmBtnTmpl]="confirmTmpl"
            [cancelBtnTmpl]="cancelTmpl">
          </ngx-material-timepicker>
          <mat-hint>Automatisch vorausgewählt</mat-hint>
          <mat-error>Bitte wählen Sie eine Startzeit.</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="end-time-field" [class.smart-rebooking-active]="isSmartRebooking()">
          <mat-label>Ende</mat-label>

          <!-- THE ICON - direct child for absolute positioning on border -->
          @if (!devModeService.isDevMode()) {
            <mat-icon
              class="info-icon"
              matTooltip="Buchungen sind nur zwischen 08:00 und 20:00 Uhr möglich."
              [matTooltipClass]="'custom-tooltip'">
              info_outline
            </mat-icon>
          }

          <input
            matInput
            formControlName="endTime"
            [ngxTimepicker]="endTimePicker"
            [format]="24"
            readonly
            required />

          <!-- The clock icon in the suffix -->
          <mat-icon matSuffix class="clock-icon" (click)="endTimePicker.open()">access_time</mat-icon>

          <ngx-material-timepicker
            #endTimePicker
            [confirmBtnTmpl]="confirmTmpl"
            [cancelBtnTmpl]="cancelTmpl">
          </ngx-material-timepicker>

          <mat-hint>Automatisch vorgeschlagen</mat-hint>
          @if (form.get('endTime')?.hasError('required')) {
            <mat-error>
              Bitte wählen Sie eine Endzeit.
            </mat-error>
          }
          @if (form.hasError('invalidTimeRange')) {
            <mat-error>
              Die Endzeit muss nach der Startzeit liegen.
            </mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Loading indicator -->
      @if (isLoadingSlots()) {
        <div class="booking-form__loading">
          <mat-spinner diameter="24"></mat-spinner>
          <span>Suche nach verfügbaren Slots...</span>
        </div>
      }

      <!-- Suggestion Chips: Proactive time slot suggestions -->
      @if (!isLoadingSlots() && suggestedSlots().length > 0) {
        <div class="booking-form__suggestions">
          <span class="booking-form__suggestions-label">Verfügbare Slots:</span>
          <mat-chip-set aria-label="Available time slots">
            @for (slot of suggestedSlots(); track slot.startTime; let i = $index) {
              <mat-chip-option
                [selected]="selectedSlotIndex() === i"
                (click)="selectSlot(i)"
                [class.booking-form__chip--selected]="selectedSlotIndex() === i">
                {{ slot.startTime }} Uhr
              </mat-chip-option>
            }
          </mat-chip-set>
        </div>
      }

      <!-- Empty state message when no slots available -->
      <!-- CRITICAL: Only show error after we've completed at least one slot calculation -->
      <!-- This prevents the error from showing during initial component load before async data arrives -->
      @if (!isLoadingSlots() && hasCalculatedSlots() && form.get('roomId')?.value && form.get('date')?.value && suggestedSlots().length === 0) {
        <div class="booking-form__no-slots">
          <mat-icon>event_busy</mat-icon>
          <span>Keine freien Slots für diesen Tag verfügbar.</span>
        </div>
      }
    </section>

    <!-- RIGHT COLUMN: Wer & Warum? -->
    <section class="booking-form__column booking-form__column--right">
      <h3 class="booking-form__section-title">
        <mat-icon>person</mat-icon>
        Wer & Warum?
      </h3>

      <mat-form-field appearance="outline">
        <mat-label>Ihr Name</mat-label>
        <input matInput formControlName="name" required #nameInput />
        <mat-error>Bitte geben Sie Ihren Namen ein.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="booking-form__comment-field">
        <mat-label>Kommentar (optional)</mat-label>
        <textarea matInput rows="6" formControlName="comment"
                  placeholder="z.B. Team-Meeting, Workshop, etc."></textarea>
        <mat-hint>Optional: Zweck der Buchung</mat-hint>
      </mat-form-field>
    </section>
  </div>

  <!-- Actions (Bottom Right) -->
  <div class="booking-form__actions">
    <button mat-stroked-button type="button" (click)="onReset()" [disabled]="isSubmitting()">
      <mat-icon>refresh</mat-icon>
      Zurücksetzen
    </button>
    <button
      mat-flat-button
      color="primary"
      type="submit"
      [disabled]="isSubmitDisabled()">
      @if (isSubmitting()) {
        <mat-spinner diameter="20"></mat-spinner>
      } @else {
        <mat-icon>event_available</mat-icon>
      }
      <span [class.gradient-text-highlight]="isSmartRebooking()">
        {{ isSubmitting() ? 'Wird gespeichert...' : 'Buchung speichern' }}
      </span>
    </button>
  </div>

  <!-- German Button Templates for ngx-material-timepicker -->
  <ng-template #cancelTmpl>
    <button mat-button style="color: grey;">Abbrechen</button>
  </ng-template>
  <ng-template #confirmTmpl>
    <button mat-flat-button color="primary">OK</button>
  </ng-template>
</form>
